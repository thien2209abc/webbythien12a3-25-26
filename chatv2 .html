<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kênh Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .message-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .prose strong { font-weight: 600; color: #1f2937; }
        .prose p { margin-bottom: 0.5rem; }
        .chip-enter { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0; transform: scale(0.8); }
        @keyframes popIn { to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden bg-white">

    <div class="w-full h-full flex flex-col relative overflow-hidden bg-white">
        
        <div id="loading-screen" class="absolute inset-0 bg-white z-50 flex flex-col items-center justify-center space-y-4">
            <div class="loader w-12 h-12 border-blue-600"></div>
            <p class="text-gray-500 text-sm font-medium">Đang tải Kênh Chat...</p>
        </div>

        <div id="summary-modal" class="absolute inset-0 z-[60] bg-black bg-opacity-50 flex items-center justify-center hidden p-4 backdrop-blur-sm">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg flex flex-col max-h-[80vh] animate-message-enter">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-blue-50 rounded-t-2xl">
                    <h3 class="font-bold text-blue-800 flex items-center gap-2">
                        <i class="fa-solid fa-wand-magic-sparkles text-purple-600"></i>
                        Tóm tắt cuộc trò chuyện
                    </h3>
                    <button id="close-summary-btn" class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white transition">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar">
                    <div id="summary-content" class="text-sm text-gray-700 leading-relaxed prose"></div>
                    <div id="summary-loading" class="flex flex-col items-center justify-center py-8 hidden">
                        <div class="loader border-purple-500 mb-3"></div>
                        <p class="text-purple-600 text-xs font-medium animate-pulse">Đang phân tích 30 tin nhắn gần nhất...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="auth-screen" class="absolute inset-0 bg-white z-40 flex flex-col items-center justify-center p-4 hidden overflow-y-auto">
            <div class="w-full max-w-md p-6">
                <div class="text-center mb-8 mt-6">
                    <div class="w-20 h-20 bg-gradient-to-tr from-blue-600 to-cyan-500 rounded-2xl flex items-center justify-center mx-auto mb-4 text-white text-3xl shadow-lg transform rotate-3">
                        <i class="fa-brands fa-rocketchat"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-800 tracking-tight">Kênh Chat</h2>
                    <p class="text-gray-500 mt-2">Đăng nhập để bắt đầu trò chuyện</p>
                </div>
                <form id="login-form" class="space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="login-email" class="block w-full px-3 py-2.5 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" required placeholder="name@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu</label>
                        <input type="password" id="login-password" class="block w-full px-3 py-2.5 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" required placeholder="••••••••">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 hover:shadow-xl transition">Đăng Nhập</button>
                </form>
                <form id="signup-form" class="space-y-5 hidden">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tên hiển thị</label>
                        <input type="text" id="signup-name" class="block w-full px-3 py-2.5 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" required placeholder="VD: Minh Tuấn">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="signup-email" class="block w-full px-3 py-2.5 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu</label>
                        <input type="password" id="signup-password" class="block w-full px-3 py-2.5 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" required>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-green-700 hover:shadow-xl transition">Đăng Ký Tài Khoản</button>
                </form>
                <p class="mt-8 text-center text-sm text-gray-600">
                    <span id="auth-toggle-text">Chưa có tài khoản?</span>
                    <button id="auth-toggle-btn" class="font-bold text-blue-600 hover:text-blue-700 ml-1">Đăng ký ngay</button>
                </p>
                <div id="auth-error" class="mt-4 text-center text-red-500 text-sm hidden font-medium bg-red-50 p-2 rounded-lg border border-red-100"></div>
            </div>
        </div>

        <div id="chat-screen" class="flex-1 flex flex-col h-full hidden bg-gray-50">
            <div class="bg-white px-4 py-3 flex items-center justify-between shadow-sm border-b border-gray-100 z-10 sticky top-0">
                <div class="flex items-center gap-3 overflow-hidden">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white text-lg shadow-md flex-shrink-0">
                        <i class="fa-brands fa-rocketchat"></i>
                    </div>
                    <div class="min-w-0">
                        <h3 class="font-bold text-gray-800 text-lg leading-tight truncate">Kênh Chat</h3>
                        <div class="flex items-center text-xs text-green-500 font-medium">
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-1 animate-pulse"></span> Trực tuyến
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <button id="open-summary-btn" class="bg-purple-50 text-purple-600 hover:bg-purple-100 px-3 py-1.5 rounded-full text-xs font-bold transition flex items-center gap-1 border border-purple-200 shadow-sm" title="Tóm tắt nội dung 30 tin nhắn gần nhất">
                        <i class="fa-solid fa-list-check"></i>
                        <span class="hidden sm:inline">Tóm tắt</span>
                    </button>

                    <div class="flex items-center space-x-2 bg-gray-50 py-1 px-2 rounded-full border border-gray-200 ml-2">
                        <div class="w-6 h-6 rounded-full bg-gray-300 flex items-center justify-center text-xs text-gray-700 font-bold" id="user-avatar">U</div>
                        <span class="text-xs font-semibold text-gray-600 max-w-[60px] truncate hidden sm:block" id="user-display-name">User</span>
                        <button id="logout-btn" class="text-gray-400 hover:text-red-500 transition ml-1" title="Đăng xuất">
                            <i class="fa-solid fa-right-from-bracket"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-hide bg-[#f0f2f5]"></div>

            <div class="bg-white p-3 border-t border-gray-200 shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
                
                <div id="smart-replies-container" class="flex gap-2 overflow-x-auto mb-2 hidden scrollbar-hide pb-1">
                </div>

                <div id="ai-status" class="hidden text-xs text-purple-600 mb-2 font-medium flex items-center px-2 animate-pulse">
                    <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> AI đang xử lý...
                </div>

                <div class="flex items-end space-x-2">
                    <button id="smart-reply-trigger" class="text-gray-400 hover:text-yellow-500 hover:bg-yellow-50 rounded-full w-10 h-10 flex items-center justify-center transition border border-transparent hover:border-yellow-200 mb-1" title="Gợi ý trả lời thông minh">
                        <i class="fa-regular fa-lightbulb text-lg"></i>
                    </button>

                    <div class="flex-1 relative group">
                        <textarea id="message-input" rows="1" class="w-full bg-gray-100 border-0 rounded-[20px] pl-4 pr-20 py-3 focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all resize-none max-h-32 text-sm text-gray-800 placeholder-gray-500" placeholder="Nhập tin nhắn..."></textarea>
                        
                        <div class="absolute right-2 bottom-2 flex gap-1">
                            <button id="translate-btn" class="text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full w-8 h-8 flex items-center justify-center transition" title="Dịch nhanh (Việt <-> Anh)">
                                <i class="fa-solid fa-language"></i>
                            </button>
                            <button id="ai-btn" class="text-gray-400 hover:text-purple-600 hover:bg-purple-50 rounded-full w-8 h-8 flex items-center justify-center transition" title="Trau chuốt tin nhắn">
                                <i class="fa-solid fa-wand-magic-sparkles"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button id="send-btn" class="bg-blue-600 text-white rounded-full w-11 h-11 flex items-center justify-center hover:bg-blue-700 active:scale-95 transition shadow-md flex-shrink-0 mb-1">
                        <i class="fa-solid fa-paper-plane text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.firebasestorage.app",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID",
            measurementId: "YOUR_MEASUREMENT_ID"
        };

        const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loadingScreen = document.getElementById('loading-screen');
        const authScreen = document.getElementById('auth-screen');
        const chatScreen = document.getElementById('chat-screen');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const authToggleBtn = document.getElementById('auth-toggle-btn');
        const authToggleText = document.getElementById('auth-toggle-text');
        const authError = document.getElementById('auth-error');

        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userDisplayName = document.getElementById('user-display-name');
        const userAvatar = document.getElementById('user-avatar');
        
        const aiBtn = document.getElementById('ai-btn'); 
        const translateBtn = document.getElementById('translate-btn'); 
        const smartReplyTrigger = document.getElementById('smart-reply-trigger'); 
        const smartRepliesContainer = document.getElementById('smart-replies-container');
        const aiStatus = document.getElementById('ai-status');

        const openSummaryBtn = document.getElementById('open-summary-btn');
        const closeSummaryBtn = document.getElementById('close-summary-btn');
        const summaryModal = document.getElementById('summary-modal');
        const summaryContent = document.getElementById('summary-content');
        const summaryLoading = document.getElementById('summary-loading');

        let currentUser = null;
        let isLoginMode = true;
        let localMessageHistory = []; 

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            loadingScreen.classList.add('hidden');
            if (user) {
                authScreen.classList.add('hidden');
                chatScreen.classList.remove('hidden');
                updateUserInfo(user);
                loadMessages();
            } else {
                authScreen.classList.remove('hidden');
                chatScreen.classList.add('hidden');
            }
        });

        function updateUserInfo(user) {
            const name = user.displayName || user.email.split('@')[0];
            userDisplayName.textContent = name;
            userAvatar.textContent = name[0].toUpperCase();
        }

        authToggleBtn.addEventListener('click', (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;
            if (isLoginMode) {
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                authToggleText.textContent = "Chưa có tài khoản?";
                authToggleBtn.textContent = "Đăng ký ngay";
            } else {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                authToggleText.textContent = "Đã có tài khoản?";
                authToggleBtn.textContent = "Đăng nhập";
            }
            authError.classList.add('hidden');
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value); }
            catch (error) { showError(error.message); }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const cred = await createUserWithEmailAndPassword(auth, document.getElementById('signup-email').value, document.getElementById('signup-password').value);
                await updateProfile(cred.user, { displayName: document.getElementById('signup-name').value });
                updateUserInfo(cred.user);
            } catch (error) { showError(error.message); }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));
        function showError(msg) { authError.textContent = msg.replace('Firebase:', '').trim(); authError.classList.remove('hidden'); }

        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if(this.value === '') this.style.height = 'auto';
        });

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;
            try {
                messageInput.value = '';
                messageInput.style.height = 'auto';
                smartRepliesContainer.classList.add('hidden'); 
                await addDoc(collection(db, "messages"), {
                    text: text,
                    uid: currentUser.uid,
                    displayName: currentUser.displayName || "User",
                    createdAt: serverTimestamp()
                });
            } catch (error) { alert("Lỗi gửi tin: " + error.message); }
        }

        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });

        let unsubscribe;
        function loadMessages() {
            if (unsubscribe) unsubscribe();
            const q = query(collection(db, "messages"), orderBy("createdAt", "asc"));
            unsubscribe = onSnapshot(q, (snapshot) => {
                messagesContainer.innerHTML = '';
                localMessageHistory = [];
                let lastDate = null;
                snapshot.forEach((doc) => {
                    const msg = doc.data();
                    const isMe = msg.uid === currentUser.uid;
                    if (msg.text && msg.displayName) localMessageHistory.push({ name: msg.displayName, text: msg.text });
                    
                    let timeString = "...";
                    let dateString = null;
                    if (msg.createdAt) {
                        const date = msg.createdAt.toDate();
                        timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        dateString = date.toLocaleDateString([], { day: 'numeric', month: 'numeric', year: 'numeric' });
                    }

                    if (dateString && dateString !== lastDate) {
                        const div = document.createElement('div');
                        div.className = "flex justify-center my-5";
                        div.innerHTML = `<span class="bg-gray-200 text-gray-600 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-wider">${dateString}</span>`;
                        messagesContainer.appendChild(div);
                        lastDate = dateString;
                    }

                    const msgDiv = document.createElement('div');
                    msgDiv.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'} message-enter mb-1`;
                    const bubbleClass = isMe ? 'bg-blue-600 text-white rounded-[20px] rounded-br-sm' : 'bg-white text-gray-800 border border-gray-200 rounded-[20px] rounded-bl-sm';
                    
                    msgDiv.innerHTML = `
                        <div class="max-w-[85%] sm:max-w-[75%] ${bubbleClass} px-4 py-2 shadow-sm relative group hover:shadow-md transition-shadow duration-200">
                            ${!isMe ? `<div class="text-xs text-gray-500 font-bold mb-1 ml-1">${escapeHtml(msg.displayName)}</div>` : ''}
                            <div class="text-[14px] leading-relaxed break-words">${escapeHtml(msg.text)}</div>
                            <div class="text-[9px] ${isMe ? 'text-blue-200' : 'text-gray-400'} text-right mt-1 opacity-90">${timeString}</div>
                        </div>
                    `;
                    messagesContainer.appendChild(msgDiv);
                });
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }
        function escapeHtml(text) { if (!text) return ""; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }

        async function callGemini(prompt) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.error?.message || response.status); }
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (error) { console.error("Gemini API Error:", error); throw error; }
        }

        aiBtn.addEventListener('click', async () => {
            const currentText = messageInput.value.trim();
            if (!currentText) { messageInput.classList.add('ring-2', 'ring-red-400'); setTimeout(() => messageInput.classList.remove('ring-2', 'ring-red-400'), 500); return; }
            
            aiBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            aiStatus.classList.remove('hidden'); aiStatus.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles mr-1"></i> Đang trau chuốt...';
            messageInput.disabled = true;

            try {
                const result = await callGemini(`Viết lại câu sau cho chuẩn chính tả, ngắn gọn và lịch sự. Trả về duy nhất kết quả: "${currentText}"`);
                if (result) { messageInput.value = result.trim(); messageInput.dispatchEvent(new Event('input')); }
            } catch (err) { alert(`Lỗi: ${err.message}`); }
            finally { 
                aiBtn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i>';
                aiStatus.classList.add('hidden'); messageInput.disabled = false; messageInput.focus(); 
            }
        });

        translateBtn.addEventListener('click', async () => {
            const currentText = messageInput.value.trim();
            if (!currentText) { messageInput.classList.add('ring-2', 'ring-red-400'); setTimeout(() => messageInput.classList.remove('ring-2', 'ring-red-400'), 500); return; }

            translateBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            aiStatus.classList.remove('hidden'); aiStatus.innerHTML = '<i class="fa-solid fa-language mr-1"></i> Đang dịch...';
            messageInput.disabled = true;

            try {
                const result = await callGemini(`Dịch câu sau: "${currentText}". Nếu là Tiếng Việt hãy dịch sang Tiếng Anh. Nếu là Tiếng Anh hãy dịch sang Tiếng Việt. Chỉ trả về kết quả dịch.`);
                if (result) { messageInput.value = result.trim(); messageInput.dispatchEvent(new Event('input')); }
            } catch (err) { alert(`Lỗi dịch: ${err.message}`); }
            finally { 
                translateBtn.innerHTML = '<i class="fa-solid fa-language"></i>';
                aiStatus.classList.add('hidden'); messageInput.disabled = false; messageInput.focus(); 
            }
        });

        smartReplyTrigger.addEventListener('click', async () => {
            if (localMessageHistory.length === 0) { alert("Chưa có tin nhắn nào để gợi ý!"); return; }

            smartReplyTrigger.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            
            const last10 = localMessageHistory.slice(-10).map(m => `${m.name}: ${m.text}`).join('\n');
            
            try {
                const result = await callGemini(`Dựa vào đoạn chat sau, hãy gợi ý 3 câu trả lời ngắn gọn, tự nhiên bằng Tiếng Việt cho người dùng hiện tại (bạn). 
                Định dạng trả về: Mỗi câu trả lời trên một dòng, không đánh số, không ngoặc kép.
                Đoạn chat:\n${last10}`);

                if (result) {
                    const replies = result.split('\n').filter(r => r.trim().length > 0).slice(0, 3);
                    smartRepliesContainer.innerHTML = '';
                    smartRepliesContainer.classList.remove('hidden');
                    
                    replies.forEach((reply, index) => {
                        const chip = document.createElement('button');
                        chip.className = `chip-enter bg-blue-50 hover:bg-blue-100 text-blue-700 text-xs px-3 py-1.5 rounded-full border border-blue-200 transition whitespace-nowrap`;
                        chip.style.animationDelay = `${index * 0.1}s`;
                        chip.textContent = reply.replace(/^[-*•]\s*/, '').trim(); 
                        
                        chip.addEventListener('click', () => {
                            messageInput.value = chip.textContent;
                            messageInput.dispatchEvent(new Event('input'));
                            messageInput.focus();
                            smartRepliesContainer.classList.add('hidden'); 
                        });
                        smartRepliesContainer.appendChild(chip);
                    });
                }
            } catch (err) { console.error(err); }
            finally { smartReplyTrigger.innerHTML = '<i class="fa-regular fa-lightbulb text-lg"></i>'; }
        });

        openSummaryBtn.addEventListener('click', async () => {
            if (localMessageHistory.length === 0) { alert("Chưa có tin nhắn!"); return; }
            summaryModal.classList.remove('hidden'); summaryContent.innerHTML = ''; summaryLoading.classList.remove('hidden');
            
            try {
                const last30 = localMessageHistory.slice(-30).map(m => `${m.name}: ${m.text}`).join('\n');
                const result = await callGemini(`Tóm tắt ngắn gọn cuộc trò chuyện sau (tiếng Việt, gạch đầu dòng):\n${last30}`);
                summaryLoading.classList.add('hidden');
                summaryContent.innerHTML = typeof marked !== 'undefined' ? marked.parse(result || "") : (result || "Lỗi").replace(/\n/g, '<br>');
            } catch (err) { summaryLoading.classList.add('hidden'); summaryContent.innerHTML = `<p class="text-red-500">${err.message}</p>`; }
        });

        closeSummaryBtn.addEventListener('click', () => summaryModal.classList.add('hidden'));
        summaryModal.addEventListener('click', (e) => { if (e.target === summaryModal) summaryModal.classList.add('hidden'); });

    </script>
</body>
</html>
